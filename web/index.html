<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Transcriptor a Braille</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<header>
  <h1>Transcriptor a Braille</h1>
  <p class="subtitle">Convierte texto entre español y braille usando Java + API REST</p>
</header>

<main class="translator">

  <section class="tcard" id="cardLeft">
    <div class="tbar">
      <span class="tlang active" id="lblLeft">español</span>
    </div>

    <textarea id="txtLeft" placeholder="Escribe aquí en español..."></textarea>

    <div class="tcontrols">
      <button id="btnRun" class="primary">Transcribir</button>
      <button id="btnClearLeft" class="primary" title="Limpiar">Limpiar texto</button>
    </div>

    <!-- Solo se muestra en Braille -> Español -->
    <div id="brailleKeyboardBox" style="display:none; margin-top: 0.75rem;">
      <label class="checkline" style="user-select:none;">
        <input type="checkbox" id="chkBrailleKeyboard">
        Teclado Braille (Q A Z W S X)
      </label>

      <div class="tinfo" style="margin-top: .35rem;">
        <small>
            Presiona las teclas Q/A/Z/W/S/X (puntos 1–6) para escribir en braille.
          <br>
        </small>
      </div>
    </div>

    <div class="tinfo">
      <small id="lblHint">Español → Braille</small>
    </div>
  </section>

  <div class="swapWrap">
    <button id="btnSwap" class="swapBtn" title="Invertir dirección">↔</button>
  </div>

  <section class="tcard" id="cardRight">
    <div class="tbar">
      <span class="tlang" id="lblRight">braille</span>
    </div>

    <textarea id="txtRight" placeholder="Aquí se mostrará el resultado..." readonly></textarea>

    <div class="tcontrols right">
      <label class="checkline">
        <input type="checkbox" id="chkEspejo">
        Modo espejo (escritura manual)
      </label>

      <button id="btnDescargar" disabled>Descargar señalética</button>
    </div>

    <canvas id="brailleCanvas" width="800" height="200" style="display:none;"></canvas>

    <div class="tinfo">
      <small>La señalética se descarga desde la salida en braille.</small>
    </div>
  </section>

</main>

<footer>
  <p>Proyecto de construcción y evolución de software - Transcriptor Braille</p>
</footer>

<script>
  let direction = "ES_TO_BR";

  const txtLeft = document.getElementById("txtLeft");
  const txtRight = document.getElementById("txtRight");

  const lblLeft = document.getElementById("lblLeft");
  const lblRight = document.getElementById("lblRight");
  const lblHint = document.getElementById("lblHint");

  const btnRun = document.getElementById("btnRun");
  const btnSwap = document.getElementById("btnSwap");
  const btnClearLeft = document.getElementById("btnClearLeft");

  const chkEspejo = document.getElementById("chkEspejo");
  const btnDescargar = document.getElementById("btnDescargar");

  const canvas = document.getElementById("brailleCanvas");
  const ctx = canvas.getContext("2d");

  // =========================
  // MODO ESPEJO (descarga)
  // =========================
  function espejoCeldaBraille(ch) {
    const code = ch.codePointAt(0);
    if (code < 0x2800 || code > 0x28FF) return ch;

    const p = code - 0x2800;

    const d1 = p & 0x01, d2 = p & 0x02, d3 = p & 0x04;
    const d4 = p & 0x08, d5 = p & 0x10, d6 = p & 0x20;
    const d7 = p & 0x40, d8 = p & 0x80;

    let mirrored = 0;
    if (d4) mirrored |= 0x01;
    if (d5) mirrored |= 0x02;
    if (d6) mirrored |= 0x04;
    if (d1) mirrored |= 0x08;
    if (d2) mirrored |= 0x10;
    if (d3) mirrored |= 0x20;
    if (d7) mirrored |= 0x40;
    if (d8) mirrored |= 0x80;

    return String.fromCodePoint(0x2800 + mirrored);
  }

  function espejoTextoBraille(texto) {
    return texto
      .split("\n")
      .map(linea => [...linea].reverse().map(espejoCeldaBraille).join(""))
      .join("\n");
  }

  // =========================
  // TECLADO BRAILLE (Perkins) - FIX
  // =========================
const brailleKeyboardBox = document.getElementById("brailleKeyboardBox");
const chkBrailleKeyboard = document.getElementById("chkBrailleKeyboard");

const dotKeyMap = { q: 1, a: 2, z: 3, w: 4, s: 5, x: 6 };

// puntos mantenidos presionados (en tiempo real)
const activeDots = new Set();

// puntos que pertenecen al "golpe" actual (stroke)
let strokeDots = new Set();
let inStroke = false;

function isBrailleKeyboardEnabled() {
  return direction === "BR_TO_ES" && chkBrailleKeyboard.checked;
}

function buildBrailleCellFromDots(dots) {
  let mask = 0;
  dots.forEach(dot => mask |= (1 << (dot - 1)));
  return String.fromCharCode(0x2800 + mask);
}

function insertAtCursor(textarea, text) {
  const start = textarea.selectionStart ?? textarea.value.length;
  const end = textarea.selectionEnd ?? textarea.value.length;
  textarea.setRangeText(text, start, end, "end");
}

function commitStrokeIfReady() {
  // Si ya no hay teclas de puntos presionadas
  if (activeDots.size === 0 && inStroke && strokeDots.size > 0) {
    const cell = buildBrailleCellFromDots(strokeDots);
    insertAtCursor(txtLeft, cell);
    strokeDots = new Set();
    inStroke = false;
  }
}

txtLeft.addEventListener("keydown", (e) => {
  if (!isBrailleKeyboardEnabled()) return;

  const key = e.key.toLowerCase();

  // Teclas de puntos
  if (dotKeyMap[key]) {
    e.preventDefault();
    const dot = dotKeyMap[key];

    activeDots.add(dot);
    // inicia stroke y guarda el dot
    inStroke = true;
    strokeDots.add(dot);
    return;
  }

  // Espacio: inserta espacio normal (no celda)
  if (e.key === " ") {
    e.preventDefault();
    insertAtCursor(txtLeft, " ");
    // reset stroke (porque espacio separa)
    activeDots.clear();
    strokeDots = new Set();
    inStroke = false;
    return;
  }

  // Enter: salto de línea
  if (e.key === "Enter") {
    e.preventDefault();
    insertAtCursor(txtLeft, "\n");
    activeDots.clear();
    strokeDots = new Set();
    inStroke = false;
    return;
  }

  // Backspace: borrar
  if (e.key === "Backspace") {
    e.preventDefault();

    const start = txtLeft.selectionStart ?? txtLeft.value.length;
    const end = txtLeft.selectionEnd ?? txtLeft.value.length;

    if (start !== end) {
      txtLeft.setRangeText("", start, end, "start");
    } else if (start > 0) {
      txtLeft.setRangeText("", start - 1, start, "start");
    }

    activeDots.clear();
    strokeDots = new Set();
    inStroke = false;
    return;
  }

  if (e.key === "Tab") return;

  // bloquear otras teclas
  e.preventDefault();
});

txtLeft.addEventListener("keyup", (e) => {
  if (!isBrailleKeyboardEnabled()) return;

  const key = e.key.toLowerCase();
  if (dotKeyMap[key]) {
    activeDots.delete(dotKeyMap[key]);
    // si se soltaron todas las teclas del golpe, inserta la celda
    commitStrokeIfReady();
  }
});

chkBrailleKeyboard.addEventListener("change", () => {
  activeDots.clear();
  strokeDots = new Set();
  inStroke = false;
  if (chkBrailleKeyboard.checked) txtLeft.focus();
});


  // Captura SOLO dentro del textarea izquierdo cuando teclado braille está activo
  txtLeft.addEventListener("keydown", (e) => {
    if (!isBrailleKeyboardEnabled()) return;

    const key = e.key.toLowerCase();

    if (dotKeyMap[key]) {
      activeDots.add(dotKeyMap[key]);
      e.preventDefault();
      return;
    }

    if (e.key === " ") {
      e.preventDefault();

      if (activeDots.size === 0) {
        insertAtCursor(txtLeft, " ");
        return;
      }

      const cell = buildBrailleCellFromDots(activeDots);
      insertAtCursor(txtLeft, cell);
      activeDots.clear();
      return;
    }

    if (e.key === "Enter") {
      e.preventDefault();
      insertAtCursor(txtLeft, "\n");
      activeDots.clear();
      return;
    }

    if (e.key === "Backspace") {
      e.preventDefault();

      const start = txtLeft.selectionStart ?? txtLeft.value.length;
      const end = txtLeft.selectionEnd ?? txtLeft.value.length;

      if (start !== end) {
        txtLeft.setRangeText("", start, end, "start");
      } else if (start > 0) {
        txtLeft.setRangeText("", start - 1, start, "start");
      }

      activeDots.clear();
      return;
    }

    if (e.key === "Tab") return;

    // Bloquea otras teclas para que no se mezclen letras normales
    e.preventDefault();
  });

  txtLeft.addEventListener("keyup", (e) => {
    if (!isBrailleKeyboardEnabled()) return;

    const key = e.key.toLowerCase();
    if (dotKeyMap[key]) activeDots.delete(dotKeyMap[key]);
  });

  chkBrailleKeyboard.addEventListener("change", () => {
    activeDots.clear();
    if (chkBrailleKeyboard.checked) txtLeft.focus();
  });

  // =========================
  // UI
  // =========================
  function updateUI() {
    // Siempre editable el input
    txtLeft.readOnly = false;
    txtRight.readOnly = true;

    if (direction === "ES_TO_BR") {
      lblLeft.textContent = "español";
      lblRight.textContent = "braille";
      lblHint.textContent = "Español → Braille";

      txtLeft.placeholder = "Escribe aquí en español...";
      txtRight.placeholder = "Aquí se mostrará el resultado en braille...";

      brailleKeyboardBox.style.display = "none";
      chkBrailleKeyboard.checked = false;
      activeDots.clear();

      btnDescargar.disabled = !txtRight.value.trim();
    } else {
      lblLeft.textContent = "braille";
      lblRight.textContent = "español";
      lblHint.textContent = "Braille → Español";

      txtLeft.placeholder = "Escribe o pega aquí en braille... (o activa Teclado Braille)";
      txtRight.placeholder = "Aquí se mostrará el resultado en español...";

      brailleKeyboardBox.style.display = "block";
      btnDescargar.disabled = true;
    }
  }

  // =========================
  // Traducción (API)
  // =========================
  async function translate() {
    const input = txtLeft.value || "";

    if (!input.trim()) {
      txtRight.value = "";
      updateUI();
      return;
    }

    if (direction === "ES_TO_BR") {
      const res = await fetch("http://localhost:8081/traducir", {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: input
      });
      const braille = await res.json();
      txtRight.value = braille;
      btnDescargar.disabled = !braille.trim();
    } else {
      const res = await fetch("http://localhost:8081/traducir-braille", {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: input
      });
      const texto = await res.json();
      txtRight.value = texto;
      btnDescargar.disabled = true;
    }
  }

  function swapDirection() {
    direction = (direction === "ES_TO_BR") ? "BR_TO_ES" : "ES_TO_BR";

    const leftVal = txtLeft.value;
    const rightVal = txtRight.value;

    txtLeft.value = rightVal;
    txtRight.value = leftVal;

    activeDots.clear();
    updateUI();
  }

  // =========================
  // Eventos
  // =========================
  btnRun.addEventListener("click", translate);
  btnSwap.addEventListener("click", swapDirection);

  btnClearLeft.addEventListener("click", () => {
    txtLeft.value = "";
    txtRight.value = "";
    activeDots.clear();
    updateUI();
    txtLeft.focus();
  });

  // Ctrl+Enter para traducir (cuando NO está teclado braille activo)
  txtLeft.addEventListener("keydown", (e) => {
    if (isBrailleKeyboardEnabled()) return;

    if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      translate();
    }
  });

  btnDescargar.addEventListener("click", () => {
    if (direction !== "ES_TO_BR") return;

    const brailleOriginal = txtRight.value.trim();
    if (!brailleOriginal) return;

    const usarEspejo = chkEspejo.checked;
    const braille = usarEspejo ? espejoTextoBraille(brailleOriginal) : brailleOriginal;

    const padding = 40;
    const fontSize = 80;
    const fontFamily = "'Segoe UI Symbol','DejaVu Sans Mono','Arial Unicode MS',monospace";

    const width = Math.max(400, braille.length * fontSize * 0.8 + padding * 2);
    const height = fontSize + padding * 2;

    canvas.width = width;
    canvas.height = height;

    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, width, height);

    ctx.fillStyle = "#000";
    ctx.font = fontSize + "px " + fontFamily;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(braille, width / 2, height / 2);

    const link = document.createElement("a");
    link.download = usarEspejo ? "senaletica-braille-espejo.png" : "senaletica-braille.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  });

  updateUI();
</script>

</body>
</html>
